
/**
 * @fileoverview Firestore Security Rules for Estrat√©gia Chinesa.
 *
 * Core Philosophy:
 * This ruleset enforces access control for VIP requests, app configuration,
 * user data, and the standalone 'sessaochinesa' page. It uses ownership-based rules
 * to protect user data and their signal feedback.
 *
 * Data Structure:
 * - `/appConfig/{doc}`: Stores global app configurations. Publicly readable.
 * - `/vipRequests/{userId}`: Stores VIP access requests. Restricted to owner.
 * - `/users/{userId}/signalFeedbacks/{feedbackId}`: Stores user-specific feedback.
 * - `/session/{docId}`: Stores session status for 'sessaochinesa'. Publicly readable.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    /**
     * @description Grants public read access. Write access is disabled from clients.
     * @path /appConfig/{configDoc}
     */
    match /appConfig/{configDoc} {
      allow read: if true;
      allow write: if false; // Should be managed from Firebase Console
    }

    /**
     * @description Rules for VIP access requests.
     * @path /vipRequests/{userId}
     */
    match /vipRequests/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow write: if isSignedIn() && isOwner(userId) && isValidVipRequestUpdate(request, resource);
    }
    
    /**
     * @description Grants public read access to the session status and score for sessaochinesa.
     * @path /session/{docId}
     */
    match /session/{docId} {
      allow read: if true;
      allow write: if false; // Should be managed from Firebase Console
    }

    /**
     * @description Rules for affiliate data.
     * @path /affiliates/{affiliateId}
     */
    match /affiliates/{affiliateId} {
      allow read: if true;
      allow write: if false; // Managed from Firebase Console only
    }

    /**
     * @description Main user data collection.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // Allow users to read/write their own document if needed in the future.
      // For now, access is primarily for the subcollection.
      allow read, write: if isSignedIn() && isOwner(userId);
      
      /**
       * @description Rules for user-specific signal feedback subcollection.
       * @path /users/{userId}/signalFeedbacks/{feedbackId}
       */
      match /signalFeedbacks/{feedbackId} {
        /**
         * @allow (create): A signed-in user can only create feedback for themselves.
         * @allow (read, update, delete): No one can read, update, or delete feedback from the client.
         */
        allow create: if isSignedIn() && isOwner(userId) && isValidFeedback(request.resource.data, userId);
        allow read, update, delete: if false;
      }
    }

    // Helper functions.
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Validates the data for a VIP request during creation or update.
     */
    function isValidVipRequestUpdate(req, res) {
      let isBrokerIdValid = req.resource.data.brokerId is string &&
                           req.resource.data.brokerId.matches("^[0-9]{8,}$");
      
      let isCreating = req.method == 'create' && 
                       req.resource.data.status == 'PENDING' &&
                       isBrokerIdValid;
      
      let isConfirmingDeposit = req.method == 'update' && 
                                req.resource.data.status == 'DEPOSIT_PENDING' &&
                                res.data.status == 'AWAITING_DEPOSIT';
                                       
      let isResubmittingRejected = req.method == 'update' &&
                                   res.data.status == 'REJECTED' &&
                                   req.resource.data.status == 'PENDING' &&
                                   isBrokerIdValid;

      return isCreating || isConfirmingDeposit || isResubmittingRejected;
    }

     /**
     * @description Validates the structure and ownership of a new feedback document.
     */
    function isValidFeedback(data, userId) {
        // Ensures the userId in the document matches the authenticated user.
        let isFeedbackOwner = data.userId == request.auth.uid && request.auth.uid == userId;
        let hasValidResult = data.result in ['WIN', 'LOSS', 'DID_NOT_ENTER'];
        let hasValidSignalData = 'asset' in data.signalData &&
                                 'expirationTime' in data.signalData &&
                                 'signal' in data.signalData &&
                                 'targetTime' in data.signalData;

        return isFeedbackOwner && hasValidResult && hasValidSignalData;
    }
  }
}
